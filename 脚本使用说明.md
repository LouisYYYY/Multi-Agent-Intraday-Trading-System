# ScreenerAgent Lite（AI 选标脚本）使用说明（实用版）

## 1. 作用与输出（当前版本）

### 1.1 作用

本脚本用于从 **黄金ETF / 跨境ETF** 中筛选 **趋势突破观察候选**（WATCH），输出给人工查看或后续模块使用。

### 1.2 当前版本不做的事

- 不输出 BUY / SELL

- 不做仓位、止损止盈

- 不自动下单

### 1.3 输出结果（每次运行）

输出一个 JSON 文件（如 `screening_result.json`），包含：

- `symbol`（ETF代码）

- `name`（名称）

- `group`（gold_etf / cross_border_etf）

- `recommendation_score`（推荐系数 0–100）

- `watch_level`（WATCH_LOW / WATCH_MID / WATCH_HIGH）

- `selection_reasons`（选择原因）

- `risk_tags`（风险标签）

---

## 2. 脚本整体流程（实际运行顺序）

1. **读取ETF标的池**（黄金ETF / 跨境ETF）

2. **连接行情源（pytdx）**

3. **拉取分钟K线（1分钟）**

4. **计算特征字段**（15m/30m涨幅、量能放大、VWAP、离高点距离等）

5. **生成 payload（给大模型的输入JSON）**

6. **调用大模型（按提示词筛选候选）**

7. **解析并校验模型输出 JSON**

8. **保存结果文件**

---

## 3. 实际使用时必须改的地方（重点）

下面这些位置是你**实际使用必须确认/修改**的。

## 3.1 ETF 标的池（必须改）

### 位置

`ETF_UNIVERSE = [...]`

### 要改什么

- 增删你要观察的 ETF

- 修正名称

- 维持正确分组：
  
  - `gold_etf`
  
  - `cross_border_etf`

### 示例（当前格式）

- `symbol`: ETF代码（字符串）

- `name`: 名称

- `group`: 分组

### 使用建议

- 第一版总数控制在 **10–15个**

- 黄金ETF：3–5个

- 跨境ETF：6–10个（宽基优先）

---

## 3.2 行情服务器列表（建议改/补充）

### 位置

`TDX_SERVERS = [...]`

### 要改什么

- 可补充更多可用服务器

- 如果某些服务器经常连不上，删掉或调顺序

### 目的

提高连接成功率与稳定性。

---

## 3.3 模型调用函数（必须改）

### 位置

`call_model(system_prompt, user_prompt)`

### 当前状态

- 代码里是 mock（示例返回）

- 只能用于演示流程

### 实际使用必须做

替换成你的真实模型调用代码（如 OpenAI 兼容接口 / 本地模型接口 / 你自己的调用方式）

### 要求

返回值必须是：

- **字符串**

- 内容是模型原始输出（目标是 JSON 文本）

---

## 3.4 Prompt 内容（建议按需调整）

### 位置

- `SYSTEM_PROMPT`

- `USER_PROMPT_TEMPLATE`

### 实际使用会改什么

- 筛选标准更严格/更宽松

- 候选数量要求

- 输出字段要求

- 理由表达风格（更简洁/更详细）

### 调整原则

- 先固定版本，不要频繁改

- 每次只改少量措辞，便于观察效果变化

---

## 3.5 候选数量（常改）

### 位置

`target_shortlist_size`  
（在 payload 中设置，或在 `build_real_payload_from_pytdx()` 传参）

### 建议默认

- `5`（Lite版）

- 后续可调到 `8–10`

---

## 3.6 特征计算阈值（后续常改）

### 位置（主要在 `build_symbol_features_from_bars()`）

会影响：

- `volatility_level` 分层阈值

- `liquidity_level` 分层阈值

- `volume_spike_ratio` 的计算窗口

- `distance_to_day_high_pct` 解释含义

### 当前阶段建议

- 先不改太多

- 先观察输出质量，再调整阈值

---

## 3.7 市场状态判断逻辑（后续会改）

### 位置

`infer_market_regime_simple(...)`

### 当前作用

给模型一个简化的市场状态（TREND_UP / RANGE / CHAOTIC 等）

### 实际使用会改什么

- 判定阈值

- 判定条件（中位数、强势数量）

- 分组 Regime（黄金与跨境分开）

### 当前阶段建议

先用简版，跑稳定后再优化。

---

## 3.8 输出文件路径（建议改）

### 位置

`save_result(result, "screening_result.json")`

### 建议改法（实际使用）

不要每次覆盖同一个文件，改成按时间保存，例如：

- `data/journal/2026-02-25/result_103500.json`

否则后续没法复盘。

---

## 3.9 调试字段是否保留（可选）

### 位置

`build_symbol_features_from_bars()` 返回值中的 `"_debug"`

### 说明

- 当前用于排查数据/特征问题，很有用

- 如果后面 payload 太大，可删减

---

## 4. 脚本主要函数说明（按实际用途）

## 4.1 `infer_market(symbol)`

根据代码判断沪/深市场（给 pytdx 用）。

- 输入：ETF代码

- 输出：`0`（深）/ `1`（沪）

> 使用时通常不用改，除非你发现某些ETF被识别错市场。

---

## 4.2 `connect_tdx()`

连接通达信行情服务器，失败会尝试下一个。

- 作用：建立行情连接

- 你需要关心：服务器列表是否可用

---

## 4.3 `fetch_bars_df(...)`

拉取某个ETF的分钟K线并整理为 DataFrame。

- 当前用于：1分钟K线

- 输入：代码、市场、K线类型、数量

- 输出：按时间排序的数据表

---

## 4.4 `build_symbol_features_from_bars(...)`

从 K 线计算给模型用的特征字段（核心函数之一）。

当前会生成（重点）：

- `pct_change_15m`

- `pct_change_30m`

- `volume_spike_ratio`

- `above_vwap`

- `distance_to_day_high_pct`

- `volatility_level`

- `liquidity_level`

- `data_status`

> 实际使用中，这个函数是后续优化效果最明显的地方之一。

---

## 4.5 `infer_market_regime_simple(...)`

根据当前样本粗略判断市场状态。

- 输出：`TREND_UP / TREND_DOWN / RANGE / CHAOTIC`

- 当前是简化逻辑，先服务于 Lite 版 prompt 使用

---

## 4.6 `build_real_payload_from_pytdx(...)`

把所有 ETF 的特征汇总成 payload（发给模型的输入JSON）。

包含：

- 当前时间

- target_shortlist_size

- market_regime

- 数据源信息

- 每个ETF的特征字段

> 这是“数据层 → AI层”的接口函数。

---

## 4.7 `call_model(...)`

调用大模型执行筛选任务。

### 当前必须处理

- 替换成真实接口

- 处理超时 / 异常 / 空返回

- 返回模型原始输出字符串

---

## 4.8 `try_parse_json(...)`

尝试从模型输出中解析 JSON。

作用：

- 兼容模型前后多输出文字的情况（尽量截取 JSON）

---

## 4.9 `validate_result(...)`

校验模型输出是否符合要求（非常重要）。

当前会检查：

- 顶层字段是否存在

- `candidates` 是否是数组

- 候选数是否超限

- `watch_level` 是否合法

- `score` 是否在 0–100

- 是否按分数降序排序

> 这个函数尽量保留，不建议删。

---

## 4.10 `save_result(...)`

保存最终 JSON 结果文件。

当前默认覆盖单文件；实际使用建议改成按时间归档。

---

## 4.11 `main()`

主流程入口，串起整条链路。

当前顺序：

- build payload

- prompt 调模型

- parse + validate

- save result

---

## 5. 如何使用（实际步骤）

## 5.1 环境准备

安装依赖：

- `pytdx`

- `pandas`

（模型调用的 SDK 依你的接口决定）

---

## 5.2 第一次运行（建议顺序）

1. **先用 mock 模型输出跑通**
   
   - 确认脚本能生成 `screening_result.json`

2. **替换 `call_model()` 为真实模型调用**
   
   - 再跑一次，确认模型能返回合法 JSON

3. **检查 payload 和 result**
   
   - 看字段是否合理
   
   - 看候选是否符合直觉

---

## 5.3 日常使用（手动）

每次运行脚本后检查：

- 是否成功连接行情源

- payload 里的 `data_status` 是否正常

- 输出候选数是否合理

- 理由是否与数据一致

---

## 5.4 建议的日常使用（很快就该做）

把脚本改成定时运行（例如每60秒一次），并保存：

- `payload_时间.json`

- `result_时间.json`

这样才能复盘和调优。

---

## 6. 当前阶段（现在要做什么）

当前版本已经跑通后，接下来优先做这 4 件事：

### 6.1 改成“按时间保存文件”（优先级高）

避免结果被覆盖，方便复盘。

### 6.2 增加循环运行（例如60秒一次）

让它在交易时段连续输出候选。

### 6.3 固定一版 Prompt，不频繁改

先观察一段时间输出质量，再调整。

### 6.4 做简单人工复盘

看输出是否符合直觉：

- 强票是否能进候选

- 弱票是否被排除

- 理由是否与特征一致

---

## 7. 后续要做什么（升级路线）

## 7.1 近期（Lite版增强）

- 优化 Prompt（更稳、更具体）

- 优化 ETF 标的池（去掉总误选标的）

- 优化特征阈值（流动性/波动分层）

- 增加输出归档与错误重试

## 7.2 中期（提高稳定性）

- 加“基线打分”（代码简单评分）做对照

- 让模型主要负责理由与风险标签

- 提升一致性，减少模型漂移

## 7.3 后期（多-Agent扩展）

- 接 `DecisionAgent`（生成 BUY/SELL/WAIT）

- 接 `RiskAgent`（风控门控）

- 再考虑自动下单执行

---

## 8. 常见问题（实际会遇到）

### 8.1 连接 pytdx 失败

- 更换/增加 `TDX_SERVERS`

- 重试

- 检查网络

### 8.2 模型输出不是 JSON

- 用 JSON 修复重试 Prompt

- 强化 Prompt 中“只能输出 JSON”的约束

- 保留 `try_parse_json()` 和 `validate_result()`

### 8.3 候选太多/太少

- 先调 `target_shortlist_size`

- 再调 Prompt 筛选标准

- 最后再改特征阈值

### 8.4 理由太空泛

- 在 Prompt 中强制“理由必须基于字段事实”

- 给模型一个好/坏理由示例

---

## 9. 一句话总结（实用口径）

这是一个 **“真实数据 + 大模型筛选”** 的 ETF 趋势突破候选脚本：脚本负责拉数据并整理特征，大模型负责按规则筛选并输出候选结果；当前先解决“选得出来、讲得清楚、能复盘”，后续再扩展到完整交易Agent。
